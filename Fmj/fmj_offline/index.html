<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ä¼é­”è®°</title>
    <link rel="icon" href="favicon.png" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-title" content="ä¼é­”è®°" />
    <meta name="full-screen" content="yes" />
    <!-- UCå¼ºåˆ¶å…¨å± -->
    <meta name="x5-fullscreen" content="true" />
    <!-- QQå¼ºåˆ¶å…¨å± -->
    <meta name="browsermode" content="application" />
    <!-- UCåº”ç”¨æ¨¡å¼ -->
    <meta name="x5-page-mode" content="app" />
    <!-- QQåº”ç”¨æ¨¡å¼ -->
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- windows phone ç‚¹å‡»æ— é«˜å…‰ -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="favicon.png" />
    <!-- iPhone å’Œ iTouchï¼Œé»˜è®¤ 57x57 åƒç´ ï¼Œå¿…é¡»æœ‰ -->
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="favicon.png" />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="114x114"
      href="favicon.png" />
    <!-- Retina iPhone å’Œ Retina iTouchï¼Œ114x114 åƒç´ ï¼Œå¯ä»¥æ²¡æœ‰ï¼Œä½†æ¨èæœ‰ -->
    <link
      rel="apple-touch-icon-precomposed"
      sizes="144x144"
      href="favicon.png" />
    <!-- Retina iPadï¼Œ144x144 åƒç´ ï¼Œå¯ä»¥æ²¡æœ‰ï¼Œä½†æ¨èæœ‰ -->
    <!-- iOS å›¾æ ‡ end -->
    <link rel="stylesheet" href="style/joystick.css" />
    <link rel="stylesheet" type="text/css" href="style/baye.css" />
    <script src="js/m-native-bridge.js"></script>
    <script src="js/iap-devtools.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/encoding-indexes.js"></script>
    <script src="js/encoding.js"></script>
    <script src="js/sys.js"></script>
    <script src="js/kotlin.js"></script>
    <script src="js/keyboard.js"></script>
    <script src="js/font.js"></script>
    <script src="js/nipplejs.min.js"></script>
    <script src="js/jquery.mobile-events.js"></script>
    <script src="js/libs/fmj.lib.js"></script>
    <script src="js/libs/fmj_wmb.lib.js"></script>
    <script src="js/libs/jyqxz.lib.js"></script>
    <script src="js/libs/xkx.lib.js"></script>
    <script src="js/libs/cbzzzsyzf.lib.js"></script>
    <script src="js/libs/yzcq2.lib.js"></script>
    <script src="js/libs/xxjwmb.lib.js"></script>
    <script src="js/libs/xjqxzezhjfj.lib.js"></script>
    <script src="js/libs/xjqxzszlhqy.lib.js"></script>
    <script src="js/libs/xjqxzshymyx.lib.js"></script>
    <script src="js/libs/lgscq.lib.js"></script>
    <script src="js/libs/fmjfyj.lib.js"></script>
    <script src="js/libs/yxts.lib.js"></script>
    <script src="js/libs/wdsj.lib.js"></script>
    <script src="js/libs/fmj_ymqzq.lib.js"></script>
    <script src="js/libs/fmj_snlwq.lib.js"></script>
    <script src="js/libs/fmj_mvkxq.lib.js"></script>
    <script src="js/libs/fmj_hmahq.lib.js"></script>
    <script src="js/libs/fmjll.lib.js"></script>
    <script src="js/libs/xbmt.lib.js"></script>
    <script src="js/box-mapping-storage.js"></script>
    <script src="js/devtools.js"></script>
    <script src="js/m.js"></script>
    <script>
      // è·å–ç¦»çº¿åŒ…ç‰ˆæœ¬å·çš„å‡½æ•°
      function getOfflinePackageVersion() {
        // ä»æ‰“åŒ…æ—¶æ³¨å…¥çš„HTMLæ³¨é‡Šä¸­è·å–ç‰ˆæœ¬ä¿¡æ¯
        const htmlContent = document.documentElement.outerHTML;
        const versionMatch = htmlContent.match(/<!-- Package Version: (\d+) -->/);
        if (versionMatch && versionMatch[1]) {
          return versionMatch[1];
        }
        return "";
      }
      
      // å¼€å‘æ—¶å¯ä»¥è°ƒç”¨ window.getOfflinePackageVersion() æŸ¥çœ‹ç‰ˆæœ¬
      window.getOfflinePackageVersion = getOfflinePackageVersion;
      
      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰“å°ç‰ˆæœ¬å·
      window.addEventListener('DOMContentLoaded', function() {
        const version = getOfflinePackageVersion();
        console.log('ğŸ® ä¼é­”è®°ç¦»çº¿åŒ…ç‰ˆæœ¬ FMJ Offline Package Version:', version);
      });
    </script>
    <style>
      .fill {
        background-color: #1a1a2e;
        width: 320px;
        height: 192px;
        /* ç§»é™¤è¾¹æ¡†ï¼Œé¿å…å’Œappå®¹å™¨çš„è¾¹æ¡†é‡å¤ */
        /* border: 2px solid #4d80e4; */
        border-radius: 8px;
        /* box-shadow: 0 0 10px rgba(77, 128, 228, 0.6); */
      }

      /* æ·»åŠ æ»¤é•œå±‚æ ·å¼ */
      .filter-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 1000;
        mix-blend-mode: multiply;
        opacity: 0;
        border-radius: 8px;
        transition: opacity 0.3s ease;
      }

      /* åœ°å›¾æ»¤é•œå±‚æ ·å¼ */
      .map-filter-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 12;
        mix-blend-mode: multiply;
        opacity: 0;
        border-radius: 5px;
        transition: opacity 0.3s ease;
      }

      .button {
        display: inline-block;
        outline: none;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        font: 16px/100% "Microsoft yahei", Arial, Helvetica, sans-serif;
        padding: 0.5em 2em 0.55em;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
        -webkit-border-radius: 0.5em;
        -moz-border-radius: 0.5em;
        border-radius: 0.5em;
        -webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        -moz-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .button:hover {
        text-decoration: none;
      }
      .button:active {
        position: relative;
        top: 1px;
      }
      .small {
        font-size: 22px;
        padding: 0.2em 1em 0.275em;
      }
      /* green */
      .green {
        color: #e8f0de;
        border: solid 1px #538312;
        background: #64991e;
        background: -webkit-gradient(
          linear,
          left top,
          left bottom,
          from(#7db72f),
          to(#4e7d0e)
        );
        background: -moz-linear-gradient(top, #7db72f, #4e7d0e);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#7db72f', endColorstr='#4e7d0e');
      }
      .green:hover {
        background: #538018;
        background: -webkit-gradient(
          linear,
          left top,
          left bottom,
          from(#6b9d28),
          to(#436b0c)
        );
        background: -moz-linear-gradient(top, #6b9d28, #436b0c);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#6b9d28', endColorstr='#436b0c');
      }
      .green:active {
        color: #a9c08c;
        background: -webkit-gradient(
          linear,
          left top,
          left bottom,
          from(#4e7d0e),
          to(#7db72f)
        );
        background: -moz-linear-gradient(top, #4e7d0e, #7db72f);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#4e7d0e', endColorstr='#7db72f');
      }

      body {
        background: rgb(19, 39, 72);
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100%;
        height: 100vh;
        min-height: -webkit-fill-available; /* è§£å†³iOS Safariåº•éƒ¨ç©ºç™½é—®é¢˜ */
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      

      /* åŸºç¡€ app æ ·å¼ */
      #app {
        position: relative;
        margin: auto;
        padding: 0px;
        overflow: hidden !important;  /* å¼ºåˆ¶ç¡®ä¿å†…å®¹è¢«åœ†è§’è£å‰ª */
        background-color: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.5),
          inset 0 0 15px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        filter: none;
        z-index: 1;
      }
      
      /* æ¨ªå±æ¨¡å¼ä¸‹çš„ app å°ºå¯¸ */
      @media screen and (orientation: landscape) {
        /* é»˜è®¤æ¨ªå±æ ·å¼ - å½“å¯ç”¨è‡ªå®šä¹‰ç¼©æ”¾æ—¶ä¼šè¢«å†…è”æ ·å¼è¦†ç›– */
        #app {
          /* åŸºç¡€æ ·å¼ï¼Œä¼šè¢«JSç¼©æ”¾è¦†ç›– */
          position: relative;
          margin: auto;
          margin-top: 0px;
        }

        #app.no-scale {
          /* åªæœ‰æ²¡æœ‰å¯ç”¨ç¼©æ”¾æ—¶æ‰ä½¿ç”¨é»˜è®¤æ ·å¼ */
          /* ä»¥é«˜åº¦ä¸ºåŸºå‡†ï¼Œä¿æŒ 320:192 (5:3) æ¯”ä¾‹ */
          height: min(70vh, 500px);
          width: calc(min(70vh, 500px) * 1.6667);
          margin-top: 0;
          padding: 0;  /* æ¨ªå±æ¨¡å¼å»æ‰å†…è¾¹è·ï¼Œç¡®ä¿æ¸¸æˆç”»é¢å®Œæ•´æ˜¾ç¤º */
          border-radius: 8px;  /* å‡å°åœ†è§’ä»¥é€‚é…æ— padding */
        }
      }
      
      /* ç«–å±æ¨¡å¼ä¸‹çš„ app å°ºå¯¸ */
      @media screen and (orientation: portrait) {
        #app {
          /* å®½åº¦å æ»¡å±å¹•ï¼Œé«˜åº¦æŒ‰ 320:192 æ¯”ä¾‹è®¡ç®— */
          width: 100vw !important;
          height: calc(100vw * 0.6) !important;  /* é«˜åº¦ = å®½åº¦ * (192/320) */
          margin-top: 0 !important;  /* è´´é¡¶éƒ¨ */
          margin-left: 0 !important;
          margin-right: 0 !important;
          border-radius: 0 !important;  /* å…¨å®½æ—¶å»æ‰åœ†è§’ */
          padding: 0 !important;  /* å…¨å®½æ—¶å»æ‰å†…è¾¹è· */
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          transform: none !important;
          z-index: 1002 !important;
          background-color: transparent !important;
          border: none !important;
          box-shadow: none !important;
        }
      }
      
      /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
      @media screen and (max-width: 480px) {
        #app {
          padding: 8px;
          border-radius: 8px;
        }
        
        #lcd {
          border-radius: 8px;  /* ç»Ÿä¸€åœ†è§’ */
        }
      }
      
      /* å°å±å¹•æ¨ªå± */
      @media screen and (max-width: 480px) and (orientation: landscape) {
        /* é»˜è®¤å°å±å¹•æ¨ªå±æ ·å¼ */
        #app {
          position: relative;
          margin: auto;
          margin-top: 0px;
        }

        #app.no-scale {
          height: min(85vh, 400px);
          width: calc(min(85vh, 400px) * 1.6667);
          padding: 0;  /* å°å±å¹•æ¨ªå±ä¹Ÿå»æ‰å†…è¾¹è· */
          border-radius: 8px;
        }
      }
      
      /* å°å±å¹•ç«–å± - åŒæ ·å æ»¡å®½åº¦ */
      @media screen and (max-width: 480px) and (orientation: portrait) {
        #app {
          width: 100vw !important;
          height: calc(100vw * 0.6) !important;
          margin-top: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          transform: none !important;
        }
      }
      
      /* Canvas æ ·å¼ - ç¡®ä¿å¡«å……å®¹å™¨å¹¶ç»§æ‰¿åœ†è§’ */
      #lcd {
        width: 100% !important;
        height: 100% !important;
        display: block;
        transform: none !important;
        -webkit-transform: none !important;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        border-radius: 8px;  /* ç»Ÿä¸€åœ†è§’ */
        box-sizing: border-box;
        object-fit: cover;  /* ç¡®ä¿å¡«å……æ•´ä¸ªå®¹å™¨ */
        margin: 0;
        padding: 0;
      }

      /* æ¨ªå±æ¨¡å¼ä¸‹çš„LCDåœ†è§’ */
      @media screen and (orientation: landscape) {
        #lcd {
          border-radius: 8px;  /* ç»Ÿä¸€åœ†è§’ */
          border: none !important;  /* ç¡®ä¿canvasæ²¡æœ‰è¾¹æ¡† */
        }

        #app {
          overflow: hidden;  /* å¼ºåˆ¶åœ¨æ¨ªå±æ¨¡å¼ä¸‹ä¹Ÿè£å‰ªå†…å®¹ */
        }
      }
      
      /* ç«–å±æ¨¡å¼ä¸‹çš„LCDåœ†è§’ */
      @media screen and (orientation: portrait) {
        #lcd {
          border-radius: 0 !important;  /* ç«–å±å…¨å±æ˜¾ç¤ºï¼Œæ— åœ†è§’ */
          width: 100% !important;
          height: 100% !important;
        }
      }
      
      /* å°å±å¹•æ¨ªå±LCDåœ†è§’ */
      @media screen and (max-width: 480px) and (orientation: landscape) {
        #lcd {
          border-radius: 8px;  /* ç»Ÿä¸€åœ†è§’ */
        }
        
        #app {
          overflow: hidden;  /* ç¡®ä¿å°å±å¹•æ¨ªå±ä¹Ÿæ­£ç¡®è£å‰ª */
        }
      }
      
      /* å°å±å¹•ç«–å±LCDåœ†è§’ */
      @media screen and (max-width: 480px) and (orientation: portrait) {
        #lcd {
          border-radius: 0;  /* ç«–å±å…¨å±æ˜¾ç¤ºï¼Œæ— åœ†è§’ */
        }
      }

      .btn {
        position: absolute;
        display: block;
        opacity: 0.8;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        transition: all 0.2s ease;
      }
      .btn img {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
      }
      .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      }

      /* ä¿ç•™spanæ ·å¼ */
      #btn_repeat span,
      #btn_help span {
        display: inline-block;
      }

      .active {
        -webkit-transform: scale(1.2);
        transform: scale(1.2);
        opacity: 1;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        background-color: rgba(255, 255, 255, 0.4);
      }

      /* ä¸ºæœ‰transformå±æ€§çš„æŒ‰é’®ç‰¹åˆ«å¤„ç†activeçŠ¶æ€ */
      #btn_enter.active {
        transform: translateY(-50%) scale(1.2) !important;
      }
      
      #btn_exit.active {
        transform: translateX(-50%) scale(1.2) !important;
      }
      
      #btn_up.active {
        transform: translateX(-50%) scale(1.2) !important;
      }
      
      #btn_down.active {
        transform: translateY(-50%) scale(1.2) !important;
      }

      /* portrait-controlsä¸­çš„æŒ‰é’®activeçŠ¶æ€ */
      .portrait-controls .action-pad #btn_enter.active {
        transform: translateY(-50%) scale(1.2) !important;
      }
      
      .portrait-controls .action-pad #btn_exit.active {
        transform: translateX(-50%) scale(1.2) !important;
      }
      
      .portrait-controls .action-pad #btn_up.active {
        transform: translateX(-50%) scale(1.2) !important;
      }
      
      .portrait-controls .action-pad #btn_down.active {
        transform: translateY(-50%) scale(1.2) !important;
      }

      #zone {
        z-index: 9999;
        pointer-events: auto;
      }
      
      /* ç¡®ä¿nipplejsåˆ›å»ºçš„å…ƒç´ ä¹Ÿåœ¨æœ€ä¸Šå±‚ */
      .nipple {
        z-index: 9999 !important;
      }

      /* æ–¹å‘æŒ‰é’®æ ·å¼ */
      .direction-pad {
        display: none;
        position: fixed;
        width: 120px;
        height: 120px;
        z-index: 9999;
      }
      
      /* æ¨ªå±æ¨¡å¼ä¸‹çš„æ–¹å‘é”®ä½ç½® - å·¦ä¸‹è§’ */
      @media screen and (orientation: landscape) {
        .direction-pad {
          left: 10px;
          bottom: 10px;
          right: auto;
          transform: none;
          width: 160px;
          height: 160px;
        }
      }
      
      /* ç«–å±æ¨¡å¼ä¸‹çš„æ–¹å‘é”®ä½ç½® - å·¦ä¸‹è§’ */
      @media screen and (orientation: portrait) {
        .direction-pad {
          left: 10px;
          bottom: 50px;
          width: 160px;
          height: 160px;
        }
      }

      .direction-btn {
        position: absolute;
        opacity: 0.6;
        width: 60px;
        height: 60px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
      }

      .direction-btn img {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
      }

      .direction-btn:active {
        transform: scale(1.1);
        background-color: rgba(255, 255, 255, 0.4);
      }

      #dir_up {
        right: 50px;
        top: 0px;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
      }

      #dir_down {
        right: 50px;
        bottom: 0px;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
      }

      #dir_left {
        left: 0;
        top: 48px;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
      }

      #dir_right {
        right: 2px;
        top: 48px;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
      }

      /* ç¦ç”¨é•¿æŒ‰é€‰æ‹© */
      .btn, .direction-btn {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .btn img, .direction-btn img {
        pointer-events: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        touch-action: manipulation;
      }

      /* ç¦ç”¨å›¾ç‰‡æ‹–åŠ¨ */
      img {
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        pointer-events: none;
        user-select: none;
      }

/* è°ƒæ•´ç«–å±æ¨¡å¼ä¸‹æŒ‰é’®çš„ä½ç½® */
.portrait-controls .direction-pad #dir_up {
  right: 50px;
  top: 0px;
}

.portrait-controls .direction-pad #dir_down {
  right: 50px;
  bottom: 0px;
}

.portrait-controls .direction-pad #dir_left {
  left: 0;
  top: 49px;
}

.portrait-controls .direction-pad #dir_right {
  right: 2px;
  top: 49px;
}

.portrait-controls .action-pad #btn_enter {
  right: 0;
  top: 50%;
  transform: translateY(-50%);
}

.portrait-controls .action-pad #btn_exit {
  left: 50%;
  bottom: 0px;
  transform: translateX(-50%);
}

.portrait-controls .action-pad #btn_up {
  left: 50%;
  top: 0px;
  transform: translateX(-50%);
}

.portrait-controls .action-pad #btn_down {
  left: 0;
  top: 50%;
  transform: translateY(-50%);
}


/* ç»Ÿä¸€ action_pad çš„æ ·å¼ç»“æ„ */
.action-pad {
  position: fixed;
  width: 160px;
  height: 160px;
  z-index: 9999;
}

/* æ¨ªå±æ¨¡å¼ä¸‹çš„æ“ä½œé”®ä½ç½® - å³ä¸‹è§’ */
@media screen and (orientation: landscape) {
  .action-pad {
    right: 10px;
    bottom: 10px;
    left: auto;
  }
}

/* ç«–å±æ¨¡å¼ä¸‹çš„æ“ä½œé”®ä½ç½® - å³ä¸‹è§’ */
@media screen and (orientation: portrait) {
  .action-pad {
    right: 10px;
    bottom: 50px;
    left: auto;
    width: 160px;
    height: 160px;
  }
}

/* ç»Ÿä¸€æŒ‰é’®åŸºç¡€æ ·å¼ */
.action-btn {
  position: absolute;
  opacity: 0.6;
  width: 60px;
  height: 60px;
  background-color: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s ease;
}

.action-btn img {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
}

.action-btn:active {
  transform: scale(1.1);
  background-color: rgba(255, 255, 255, 0.4);
}

#btn_enter {
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  border-color: rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
}

#btn_exit {
  left: 50%;
  bottom: 0px;
  transform: translateX(-50%);
  border-color: rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
}

#btn_up {
  left: 50%;
  top: 0px;
  transform: translateX(-50%);
  border-color: rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
}

#btn_down {
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  border-color: rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
}

/* Ré”®æŒ‰é’®å®¹å™¨ - é»˜è®¤å°±æ˜¾ç¤º */
.repeat-btn-container {
  position: fixed;
  width: 60px;
  height: 60px;
  z-index: 9999;
}

/* æ¨ªå±æ¨¡å¼ä¸‹Ré”®ä½ç½® - ä¸­é—´åå³ */
@media screen and (orientation: landscape) {
  .repeat-btn-container {
    left: 65%;
    bottom: 50px;
    transform: translateX(-50%) translateY(50%);
    -webkit-transform: translateX(-50%) translateY(50%);
  }
}

/* ç«–å±æ¨¡å¼ä¸‹Ré”®ä½ç½® - Hé”®ä¸Šæ–¹ */
@media screen and (orientation: portrait) {
  .repeat-btn-container {
    left: 50%;
    bottom: 160px;
    transform: translateX(-50%);
    -webkit-transform: translateX(-50%);
  }
}

/* ç«–å±æ¨¡å¼ä¸‹åœ¨portrait-controlså†…éƒ¨çš„ç‰¹æ®Šå¤„ç† */
.portrait-controls .repeat-btn-container {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  z-index: 10;
  display: block !important;
}

/* Ré”®æŒ‰é’®æ ·å¼ */
.repeat-btn-container #btn_repeat {
  position: absolute;
  width: 60px;
  height: 60px;
  opacity: 0.6;
  background-color: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  left: 0;
  top: 0;
  transition: all 0.2s ease;
}

.repeat-btn-container #btn_repeat:active {
  transform: scale(1.1);
  background-color: rgba(255, 255, 255, 0.4);
}

/* Hé”®æŒ‰é’®å®¹å™¨ - é»˜è®¤å°±æ˜¾ç¤º */
.help-btn-container {
  position: fixed;
  width: 60px;
  height: 60px;
  z-index: 2000;
  transition: all 0.3s ease;
  -webkit-transition: all 0.3s ease;
  display: block;
}

/* æ¨ªå±æ¨¡å¼ä¸‹Hé”®ä½ç½® - ä¸­é—´åå·¦ */
@media screen and (orientation: landscape) {
  .help-btn-container {
    left: 35%;
    bottom: 50px;
    transform: translateX(-50%) translateY(50%);
    -webkit-transform: translateX(-50%) translateY(50%);
  }
}

/* ç«–å±æ¨¡å¼ä¸‹Hé”®ä½ç½® - åº•éƒ¨å±…ä¸­ */
@media screen and (orientation: portrait) {
  .help-btn-container {
    left: 50%;
    bottom: 50px;
    transform: translateX(-50%);
    -webkit-transform: translateX(-50%);
  }
}

/* ç«–å±æ¨¡å¼ä¸‹Hé”®ä½ç½® - åœ¨portrait-controlså†…éƒ¨ */
.portrait-controls .help-btn-container {
  position: absolute;
  left: 50%;
  top: 30%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  z-index: 10;
  display: block !important;
}

/* Hé”®æŒ‰é’®æ ·å¼ */
.help-btn-container #btn_help {
  position: absolute;
  width: 60px;
  height: 60px;
  opacity: 0.6;
  background-color: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  box-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  left: 0;
  top: 0;
  transition: all 0.2s ease;
}

.help-btn-container #btn_help:active {
  transform: scale(1.1);
  background-color: rgba(255, 255, 255, 0.4);
}

/* ç«–å±æ¨¡å¼ä¸‹çš„æ§åˆ¶é¢æ¿æ ·å¼ */
.portrait-controls {
  position: fixed;
  left: 50%;
  right: 50%;
  bottom: 240px;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  transform: translate(-50%, -50%) rotate(90deg);
  transform-origin: center center;
  z-index: 9999;
}

.portrait-controls .direction-pad {
  position: relative;
  display: flex;
  transform-origin: center center;
  width: 160px;
  height: 160px;
}

.portrait-controls .action-pad {
  position: relative;
  display: flex;
  transform-origin: center center;
  width: 160px;
  height: 160px;
}

/* ç¦ç”¨é•¿æŒ‰é€‰æ‹© */
.action-btn {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.action-btn img {
  pointer-events: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}

/* ç©å®¶ä½ç½®é—ªçƒåŠ¨ç”» */
@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0.3; }
}

#player-dot {
  animation: blink 1s infinite;
}

    </style>
  </head>
  <body>
    <div id="app" class="no-scale">
      <!-- canvaså°†é€šè¿‡JavaScriptåŠ¨æ€åˆ›å»ºï¼Œæ ¹æ®window.fmjcorev2è®¾ç½®å°ºå¯¸ -->
      <!-- æ·»åŠ æ»¤é•œå±‚ -->
      <div id="filterOverlay" class="filter-overlay"></div>
      <!-- <div id="version" style="position: absolute; background-color: rgba(0, 0, 0, 0.6); color: #fff; top: 10px; left: 10px; padding: 5px 10px; border-radius: 15px; box-shadow: 0 0 10px rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); font-family: Arial, sans-serif; font-size: 14px; letter-spacing: 1px;"></div> -->
    </div>

    <!-- åœ°å›¾è°ƒè¯•åŒºåŸŸ - å®Œå…¨å¯¹é½appå…ƒç´ çš„æ‰€æœ‰æ ·å¼å±æ€§ -->
    <div id="map-container" style="position: fixed; bottom: 5px; left: 50%; transform: translateX(-50%); margin: 0px; padding: 2px; overflow: hidden !important; background-color: rgba(0, 0, 0, 0.4); border-radius: 5px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5), inset 0 0 5px rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); filter: none; transition: filter 0.3s ease; color: #fff; font-family: 'Courier New', monospace; display: none; max-width: calc(100% - 4px); box-sizing: border-box; z-index: 1000;">
      <div style="background: #000; padding: 0px; border-radius: 5px; margin: 0px; position: relative; overflow: hidden;">
        <img id="map-preview" src="" alt="åœ°å›¾é¢„è§ˆ" style="width: 100%; max-width: 100%; height: auto; max-height: 100%; border: none; image-rendering: pixelated; display: block; object-fit: contain; border-radius: 5px;" />
        <div id="player-dot" style="position: absolute; background: red; border-radius: 50%; display: none; z-index: 10; box-shadow: 0 0 4px rgba(255,0,0,0.8);"></div>
        <div id="player-coords" style="position: absolute; color: #ffff00; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000; display: none; z-index: 11; white-space: nowrap;"></div>
        <!-- åœ°å›¾æ»¤é•œå±‚ -->
        <div id="mapFilterOverlay" class="map-filter-overlay"></div>
      </div>
    </div>

    <div id="zone"></div>

    <!-- æ–¹å‘æŒ‰é’® -->
    <div class="direction-pad" id="direction_pad">
      <div class="direction-btn" id="dir_up">
        <img src="images/up.png" alt="ä¸Š" />
      </div>
      <div class="direction-btn" id="dir_down">
        <img src="images/down.png" alt="ä¸‹" />
      </div>
      <div class="direction-btn" id="dir_left">
        <img src="images/left.png" alt="å·¦" />
      </div>
      <div class="direction-btn" id="dir_right">
        <img src="images/right.png" alt="å³" />
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-pad" id="action_pad">
      <div class="action-btn" id="btn_enter">
        <img src="images/enter.png" alt="ç¡®è®¤" />
      </div>
      <div class="action-btn" id="btn_exit">
        <img src="images/exit.png" alt="å–æ¶ˆ" />
      </div>
      <div class="action-btn" id="btn_up">
        <img src="images/up.png" alt="ä¸Šä¸€ä¸ª" />
      </div>
      <div class="action-btn" id="btn_down">
        <img src="images/down.png" alt="ä¸‹ä¸€ä¸ª" />
      </div>
    </div>

    <!-- Ré”®æŒ‰é’® - ç‹¬ç«‹æ”¾ç½®åœ¨æ–¹å‘é”®å’Œæ“ä½œé”®ä¹‹é—´ -->
    <div class="repeat-btn-container" id="repeat_btn_container">
      <div class="action-btn" id="btn_repeat">
        <span style="color: white; font-size: 20px; font-weight: bold;">R</span>
      </div>
    </div>
    
    <!-- Hé”®æŒ‰é’® - å†…ç½®åŠŸèƒ½æŒ‰é’® -->
    <div class="help-btn-container" id="help_btn_container">
      <div class="action-btn" id="btn_help">
        <span style="color: white; font-size: 20px; font-weight: bold;">H</span>
      </div>
    </div>
  </body>
  <script>
    
    // åŠ¨æ€åˆ›å»ºcanvas - æ ¹æ®å¼•æ“ç‰ˆæœ¬è®¾ç½®å°ºå¯¸
    (function() {
      var canvas = document.createElement('canvas');
      canvas.className = 'fill';
      canvas.id = 'lcd';
      
      if (window.fmjcorev2) {
        // v2å¼•æ“ä½¿ç”¨320x192å°ºå¯¸
        canvas.width = 320;
        canvas.height = 192;
        console.log('Creating canvas with v2 dimensions: 320x192');
      } else {
        // v1å¼•æ“ä½¿ç”¨160x96å°ºå¯¸
        canvas.width = 160;
        canvas.height = 96;
        console.log('Creating canvas with v1 dimensions: 160x96');
      }
      
      // å°†canvasæ’å…¥åˆ°app divçš„å¼€å¤´
      var appDiv = document.getElementById('app');
      var firstChild = appDiv.firstChild;
      appDiv.insertBefore(canvas, firstChild);
    })();
  </script>

  <script>
    // åŠ¨æ€åŠ è½½æ¸¸æˆå¼•æ“ - æ ¹æ®iOSæ³¨å…¥çš„å˜é‡å†³å®šåŠ è½½å“ªä¸ªç‰ˆæœ¬
    (function() {
      var script = document.createElement('script');
      if (window.fmjcorev2) {
        // åŠ è½½v2å¼•æ“
        script.src = 'js/fmj.core.v2.js';
        console.log('Loading fmj.core.v2.js (v2 engine)');
      } else {
        // åŠ è½½v1å¼•æ“
        script.src = 'js/fmj.core.js';
        console.log('Loading fmj.core.js (v1 engine)');
      }
      
      script.onload = function() {
        console.log('Game engine loaded successfully:', script.src);
      };
      
      script.onerror = function() {
        console.error('Failed to load game engine:', script.src);
      };
      
      document.head.appendChild(script);
    })();
  </script>
  <script>
    var core;
    
    // ç­‰å¾…æ¸¸æˆå¼•æ“åŠ è½½å®Œæˆååˆå§‹åŒ–
    function waitForEngine() {
      if (window["fmj.core"] && window["fmj.core"].fmj) {
        core = window["fmj.core"].fmj;
        console.log('Game engine initialized successfully');
      } else {
        // å¦‚æœå¼•æ“è¿˜æ²¡åŠ è½½å®Œæˆï¼Œç»§ç»­ç­‰å¾…
        setTimeout(waitForEngine, 100);
      }
    }
    
    // å¼€å§‹ç­‰å¾…å¼•æ“åŠ è½½
    waitForEngine();
    
    // å­˜å‚¨å½“å‰ç©å®¶ä½ç½®æ•°æ®ï¼Œç”¨äºçª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
    window.currentPlayerPosition = null;

    // æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥è·Ÿè¸ªåˆå§‹åŒ–çŠ¶æ€
    let isInitializing = false;
    let lastOrientation = null;

    function initScreen() {
      // é˜²æ­¢é‡å¤åˆå§‹åŒ–
      if (isInitializing) return;

      // æ£€æµ‹å±å¹•æ–¹å‘
      const isPortrait = window.innerHeight > window.innerWidth;
      const currentOrientation = isPortrait ? 'portrait' : 'landscape';

      // å¦‚æœæ–¹å‘æ²¡æœ‰æ”¹å˜ï¼Œä¸éœ€è¦é‡æ–°åˆå§‹åŒ–
      if (lastOrientation === currentOrientation) {
        return;
      }

      isInitializing = true;
      lastOrientation = currentOrientation;

      // åˆå§‹åŒ–æ¨ªå±æ¨¡å¼çš„ç¼©æ”¾åŠŸèƒ½
      if (!isPortrait) {
        // æ¯æ¬¡åˆ‡æ¢åˆ°æ¨ªå±éƒ½é‡æ–°åˆå§‹åŒ–ï¼Œç¡®ä¿åº”ç”¨ä¿å­˜çš„ç¼©æ”¾
        if (typeof initLandscapeScaling === 'function') {
          // ä¸éœ€è¦åœ¨è¿™é‡Œå†æ¬¡è¯»å–localStorage
          // å› ä¸ºm.jsçš„åˆå§‹åŒ–ä»£ç å·²ç»å¤„ç†äº†
          console.log('initScreen - å½“å‰ window.landscapeScale:', window.landscapeScale);
          initLandscapeScaling();
        }
      } else {
        // ç«–å±æ¨¡å¼ä¸‹é‡ç½®æ‰€æœ‰æ¨ªå±ç¼©æ”¾è®¾ç½®
        if (typeof resetPortraitStyles === 'function') {
          resetPortraitStyles();
        }
      }

      // åˆå§‹åŒ–ç«–å±æ¨¡å¼ä¸‹çš„ç¼–è¾‘åŠŸèƒ½
      if (isPortrait) {
        // åˆ›å»ºç¼–è¾‘æŒ‰é’®
        if (!document.querySelector('.portrait-edit-btn')) {
          const editBtn = $('<div class="portrait-edit-btn">â‹®</div>');
          $('body').append(editBtn);
          editBtn.css('display', 'block');
        } else {
          $('.portrait-edit-btn').css('display', 'block');
        }
        
        // åˆå§‹åŒ–ç¼–è¾‘æ¨¡å¼
        if (typeof initPortraitEditMode === 'function') {
          initPortraitEditMode();
        }
        
        // ç«–å±æ¨¡å¼ä¸‹appä¸å¯æ‹–æ‹½ï¼Œä¿æŒå›ºå®šä½ç½®
        
        // ä¸ºLCDå…ƒç´ æ·»åŠ ç‹¬ç«‹æ‹–æ‹½åŠŸèƒ½
        if ($('#lcd').length > 0) {
          $('#lcd').addClass('draggable-element');
          if (typeof initDraggable === 'function') {
            initDraggable(document.getElementById('lcd'), 'lcd');
          }
        }
        
        if ($('#map-container').length > 0) {
          $('#map-container').addClass('draggable-element');
          // ç¡®ä¿map-containeræ­£ç¡®å±…ä¸­
          $('#map-container').css('transform', 'translateX(-50%)');
          if (typeof initDraggable === 'function') {
            initDraggable(document.getElementById('map-container'), 'mapContainer');
          }
        }
        
        // ç«–å±æ¨¡å¼ä¸‹æ¢å¤æ‰€æœ‰å…ƒç´ çš„æ‹–æ‹½ä½ç½®
        restorePortraitPositions();
        
        // ç«–å±æ¨¡å¼ä¸‹æ›´æ–°åœ°å›¾å®¹å™¨æ˜¾ç¤ºçŠ¶æ€
        if (typeof updateMapContainerDisplay === 'function') {
          updateMapContainerDisplay();
        }
      } else {
        // æ¨ªå±æ¨¡å¼ä¸‹éšè—ç¼–è¾‘æŒ‰é’®
        $('.portrait-edit-btn').hide();
        
        // æ¨ªå±æ¨¡å¼ä¸‹ç§»é™¤æ‹–æ‹½åŠŸèƒ½
        $('#app').removeClass('draggable-element');
        $('#lcd').removeClass('draggable-element');
        $('#map-container').removeClass('draggable-element');
        
        // é‡ç½®æ‹–æ‹½å…ƒç´ çš„ä½ç½®ï¼Œä½†ä¸æ¸…é™¤appçš„transformï¼ˆå› ä¸ºæ¨ªå±ç¼©æ”¾éœ€è¦ï¼‰
        $('#lcd').css('transform', '');  // æ¸…é™¤lcdçš„transform
        $('#map-container').css('transform', 'translateX(-50%)');  // map-containerä¿æŒå±…ä¸­
        
        // ç§»é™¤æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
        const appElement = document.getElementById('app');
        const lcdElement = document.getElementById('lcd');
        const mapElement = document.getElementById('map-container');
        
        if (appElement && appElement._handleStart) {
          appElement.removeEventListener('touchstart', appElement._handleStart);
          appElement.removeEventListener('mousedown', appElement._handleStart);
          document.removeEventListener('touchmove', appElement._handleMove);
          document.removeEventListener('mousemove', appElement._handleMove);
          document.removeEventListener('touchend', appElement._handleEnd);
          document.removeEventListener('mouseup', appElement._handleEnd);
        }
        
        if (lcdElement && lcdElement._handleStart) {
          lcdElement.removeEventListener('touchstart', lcdElement._handleStart);
          lcdElement.removeEventListener('mousedown', lcdElement._handleStart);
          document.removeEventListener('touchmove', lcdElement._handleMove);
          document.removeEventListener('mousemove', lcdElement._handleMove);
          document.removeEventListener('touchend', lcdElement._handleEnd);
          document.removeEventListener('mouseup', lcdElement._handleEnd);
        }
        
        if (mapElement && mapElement._handleStart) {
          mapElement.removeEventListener('touchstart', mapElement._handleStart);
          mapElement.removeEventListener('mousedown', mapElement._handleStart);
          document.removeEventListener('touchmove', mapElement._handleMove);
          document.removeEventListener('mousemove', mapElement._handleMove);
          document.removeEventListener('touchend', mapElement._handleEnd);
          document.removeEventListener('mouseup', mapElement._handleEnd);
        }
        
        // æ¨ªå±æ¨¡å¼ä¸‹éšè—åœ°å›¾å®¹å™¨
        if (typeof updateMapContainerDisplay === 'function') {
          updateMapContainerDisplay();
        }
      }
      
      // æ›´æ–° body ç±»åä»¥ä¾¿ CSS é€‰æ‹©å™¨å·¥ä½œ
      if (isPortrait) {
        document.body.classList.add('portrait');
        document.body.classList.remove('landscape');
        // ç«–å±æ¨¡å¼ï¼šä¸åšä»»ä½•å°ºå¯¸ä¿®æ”¹ï¼Œè®© CSS æ§åˆ¶
      } else {
        document.body.classList.add('landscape');
        document.body.classList.remove('portrait');
        // æ¨ªå±æ¨¡å¼ï¼šä¸åšä»»ä½•å°ºå¯¸ä¿®æ”¹ï¼Œè®© CSS æ§åˆ¶
      }
      
      // åªåœ¨ç«–å±æ¨¡å¼ä¸‹æ¸…é™¤å†…è”æ ·å¼
      const app = document.getElementById('app');
      if (app && isPortrait) {
        // ç«–å±æ¨¡å¼ï¼šæ¸…é™¤æ¨ªå±è®¾ç½®çš„å†…è”æ ·å¼
        app.style.width = '';
        app.style.height = '';
        app.style.marginTop = '';
        app.style.transform = '';
        app.style.position = '';
        app.style.top = '';
        app.style.left = '';
      }
      // æ¨ªå±æ¨¡å¼ä¸‹ä¸æ¸…é™¤æ ·å¼ï¼Œè®©initLandscapeScalingå¤„ç†

      // æ›´æ–°filterOverlayçš„å¤§å°å’Œä½ç½®
      const overlay = document.getElementById('filterOverlay');
      if (overlay) {
        // åŒæ­¥overlayçš„ä½ç½®å’Œå¤§å°
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
      }

      // è·å–çª—å£å°ºå¯¸
      const width = window.innerWidth;
      const height = window.innerHeight;

      // LCD ç”»å¸ƒæ ·å¼å¤„ç†
      const lcd = document.getElementById('lcd');
      if (lcd) {
        if (isPortrait) {
          // ç«–å±æ¨¡å¼ï¼šæ¸…é™¤æ¨ªå±çš„å†…è”æ ·å¼ï¼Œè®©CSSæ¥ç®¡
          lcd.style.width = '100%';
          lcd.style.height = '100%';
          lcd.style.transform = 'none';
          lcd.style.webkitTransform = 'none';
          lcd.style.border = 'none';
        }
        // æ¨ªå±æ¨¡å¼ï¼šä¸ä¿®æ”¹æ ·å¼ï¼Œè®©applyLandscapeScaleå¤„ç†
      }

      if (isPortrait) {
        console.log("ç«–å±çŠ¶æ€");
        lcdRotateMode = 2;
      } else {
        console.log("æ¨ªå±çŠ¶æ€");
        lcdRotateMode = 0;
      }

      // é‡ç½®åˆå§‹åŒ–æ ‡å¿—
      setTimeout(() => {
        isInitializing = false;
      }, 50); // å‡å°‘å»¶è¿Ÿï¼Œé¿å…é˜»å¡
    }

    (function () {
      document.getElementById("lcd").addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        false
      );
      document.getElementById("btn_enter").addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        false
      );
      document.getElementById("btn_exit").addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        false
      );
      document.getElementById("btn_repeat").addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        false
      );
      $("#btn_enter").on("tapstart", function (e) {
        console.log("User tapped");
        $(this).addClass("active");
        onKeyDown(7);
      });

      $("#btn_exit").on("tapstart", function (e) {
        console.log("User tapped");
        $(this).addClass("active");
        onKeyDown(8);
      });

      $("#btn_up").on("tapstart", function (e) {
        $(this).addClass("active");
        onKeyDown(5);
      });

      $("#btn_down").on("tapstart", function (e) {
        $(this).addClass("active");
        onKeyDown(6);
      });

      $("#btn_repeat").on("tapstart", function (e) {
        console.log("R key pressed");
        $(this).addClass("active");
        onKeyDown(9);
      });

      $("#btn_enter,#btn_exit,#btn_up,#btn_down").on("tapend", function (e) {
        $(this).removeClass("active");
        e.preventDefault();
      });

      // Ré”®å•ç‹¬å¤„ç†tapend
      $("#btn_repeat").on("tapend", function (e) {
        $(this).removeClass("active");
        e.preventDefault();
      });
      
      // Hé”®äº‹ä»¶å¤„ç†
      $("#btn_help").on("tapstart", function (e) {
        console.log("H key pressed - opening game settings");
        $(this).addClass("active");
        onKeyDown(11); // å‘é€Hé”®äº‹ä»¶ (KEY_HELP = 11)
        e.preventDefault();
      });
      
      $("#btn_help").on("tapend", function (e) {
        $(this).removeClass("active");
        e.preventDefault();
      });
      
      // Hé”®é˜²æ­¢é»˜è®¤è§¦æ‘¸äº‹ä»¶
      document.getElementById("btn_help").addEventListener(
        "touchmove",
        function (e) {
          e.preventDefault();
        },
        false
      );

      // æ–¹å‘æŒ‰é’®äº‹ä»¶å¤„ç†
      $("#dir_up").on("tapstart", function(e) {
        $(this).addClass("active");
        setIntervalKeyDown(1); // ç»Ÿä¸€å‘é€ä¸Šé”®
      });

      $("#dir_down").on("tapstart", function(e) {
        $(this).addClass("active");
        setIntervalKeyDown(2); // ç»Ÿä¸€å‘é€ä¸‹é”®
      });

      $("#dir_left").on("tapstart", function(e) {
        $(this).addClass("active");
        setIntervalKeyDown(3); // ç»Ÿä¸€å‘é€å·¦é”®
      });

      $("#dir_right").on("tapstart", function(e) {
        $(this).addClass("active");
        setIntervalKeyDown(4); // ç»Ÿä¸€å‘é€å³é”®
      });

      // æ–¹å‘æŒ‰é’®é‡Šæ”¾äº‹ä»¶
      $("#dir_up, #dir_down, #dir_left, #dir_right").on("tapend", function(e) {
        $(this).removeClass("active");
        clearInterval(interval);
        e.preventDefault();
      });

      // é˜²æ­¢æ–¹å‘æŒ‰é’®çš„è§¦æ‘¸äº‹ä»¶ä¼ æ’­
      $("#direction_pad").on("touchmove", function(e) {
        e.preventDefault();
      });

      // åˆå§‹åŒ–æ—¶éšè—æ–¹å‘æŒ‰é’®ï¼ˆé»˜è®¤ä½¿ç”¨æ‘‡æ†æ¨¡å¼ï¼‰
      $("#direction_pad").hide();
      
      var init = function () {
        var updateOrientation = function () {
          // æ–¹å‘æ”¹å˜æ‰§è¡Œçš„å‡½æ•°
          var orientation = window.orientation;
          
          // è®¾ç½®å…¨å±€ modal å˜é‡
          if (orientation === 90 || orientation === -90) {
            modal = "landscape";
          } else {
            modal = "portrait";
          }
          
          // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
          initScreen();
          
          // é‡æ–°åˆå§‹åŒ–æ‘‡æ†ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if (typeof initJoystick === 'function') {
            initJoystick();
          }
          
          // ä¸º html å…ƒç´ æ·»åŠ æ–¹å‘ç±»
          document.documentElement.setAttribute("class", modal);
          
        };
        // å±å¹•æ—‹è½¬äº‹ä»¶
        window.addEventListener("orientationchange", updateOrientation, false);
        // äº‹ä»¶çš„åˆå§‹åŒ–
        updateOrientation();
      };
      window.addEventListener("DOMContentLoaded", init, false);
    })();

    var interval;
    var modal;
    var joystickHold = false;
    var joystick;
    function setIntervalKeyDown(key) {
      onKeyDown(key);
      clearInterval(interval);
      //setTimeout(function(){

      // æ ¹æ®æ¸¸æˆé€Ÿåº¦è®¡ç®—å»¶æ—¶ï¼šä¸€å€é€Ÿ300msï¼Œä¸¤å€é€Ÿ150msï¼Œä¸‰å€é€Ÿ100ms
      var gameSpeed = window.gameSpeedMultiple || 1.0;
      var delay;
      if (gameSpeed <= 1.0) {
        delay = 300; // ä¸€å€é€ŸåŠä»¥ä¸‹
      } else if (gameSpeed <= 2.0) {
        delay = 150; // ä¸¤å€é€Ÿ
      } else {
        delay = 100; // ä¸‰å€é€ŸåŠä»¥ä¸Š
      }

      interval = setInterval("onKeyDown(" + key + ")", delay);
      //}, 600)
    }

    joystickModeChanged(1);

    function initJoystick() {
      var position = {
        left: "15%",
        top: "75%",
      };

      if (modal == "portrait") {
        position = {
          left: "81%",  // ä½¿ç”¨ç™¾åˆ†æ¯”æ›¿ä»£å›ºå®šåƒç´ 
          top: "85%",   // ä½¿ç”¨ç™¾åˆ†æ¯”æ›¿ä»£å›ºå®šåƒç´ 
        };
      }

      var options = {
        zone: document.getElementById("zone"),
        //threshold : 1,
        mode: "static",
        position: position,
        color: "#e94560",
        size: 140,
        fadeTime: 100,
        lockX: false,
        lockY: false,
        dynamicPage: true,
        restJoystick: true,
        restOpacity: 0.8,
      };
      if (joystick) {
        joystick.destroy();
      }
      joystick = nipplejs.create(options);
      joystick
        .on("dir:up", function (evt, nipple) {
          setIntervalKeyDown(1); // ç»Ÿä¸€å‘é€ä¸Šé”®
        })
        .on("dir:down", function (evt, nipple) {
          setIntervalKeyDown(2); // ç»Ÿä¸€å‘é€ä¸‹é”®
        })
        .on("dir:left", function (evt, nipple) {
          setIntervalKeyDown(3); // ç»Ÿä¸€å‘é€å·¦é”®
        })
        .on("dir:right", function (evt, nipple) {
          setIntervalKeyDown(4); // ç»Ÿä¸€å‘é€å³é”®
        })
        .on("end", function (evt, nipple) {
          console.log("end");
          clearInterval(interval);
        });
    }

    document.addEventListener('dblclick', function(event) {
      event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„åŒå‡»ç¼©æ”¾è¡Œä¸º
      window.scrollTo(0, 0); // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    }, {passive: false}); // é¿å…passiveæ¨¡å¼ä¸‹æ— æ³•é˜»æ­¢é»˜è®¤äº‹ä»¶
    
    // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
    let resizeTimer;
    function debounceInitScreen() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        initScreen();
      }, 150);
    }

    // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–å’Œçª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
      // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è°ƒç”¨
      debounceInitScreen();
    });

    // orientationchangeäº‹ä»¶å·²ç»åœ¨ä¸Šé¢çš„initå‡½æ•°ä¸­å¤„ç†äº†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤ç›‘å¬
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å±å¹•
    document.addEventListener('DOMContentLoaded', function() {
      // ç¡®ä¿ä»localStorageæ¢å¤ç¼©æ”¾å€¼
      const savedScale = localStorage.getItem('landscape_scale');
      if (savedScale) {
        window.landscapeScale = parseFloat(savedScale);
        console.log('DOMContentLoaded - æ¢å¤ç¼©æ”¾å€¼:', window.landscapeScale);
      }

      setTimeout(function() {
        initScreen();
      }, 100);
    });
  </script>
</html>