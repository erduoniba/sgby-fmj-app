# 敌人魔法释放计算公式文档

基于 FMJ C 引擎源码分析的敌人AI魔法释放系统完整技术文档。

## 概述

敌人魔法释放系统基于智商（IQ）和随机数进行决策，包含魔法释放概率计算、魔法选择算法、以及伤害计算公式。

## 核心数据结构

### 敌人角色内存布局 (`0x1826 + idx*0x33`)
```c
struct EnemyCharacter {
    UINT8  statusEffects;      // +0x04: 普通攻击状态效果 [bit3:毒,bit2:乱,bit1:封,bit0:眠]
    UINT8  spriteId;          // +0x05: 敌人角色图片ID
    UINT8  learnedMagicCount; // +0x02: 敌人角色学会的魔法数量
    
    // +0x12: 详细属性数据开始
    UINT8  agility;           // +0x13: 身法
    UINT8  spirit;            // +0x14: 灵力  
    UINT8  intelligence;      // +0x15: 智商 (用于魔法释放概率)
    UINT16 currentHP;         // +0x1A: 当前HP
    UINT16 currentMP;         // +0x1E: 当前MP
    UINT16 attack;            // +0x20: 攻击力
    UINT16 defense;           // +0x22: 防御力
    UINT8  effectDuration;    // +0x29: 持续效果回合数
    
    UINT16 magicChainPtr;     // +0x31: 指向魔法链数据的指针
};
```

### 属性增减益 (`0x180F + idx*5`)
```c
struct EnemyAttributeModifier {
    UINT16 attackBonus;       // +0x00: 攻击增减益
    UINT16 defenseBonus;      // +0x02: 防御增减益  
    UINT16 agilityBonus;      // +0x04: 身法增减益
};
```

## 魔法释放决策算法

### 1. 基础概率计算
```c
// 敌人角色智商计算：智商 = 100 - 原始智商值
UINT8 intelligence = 100 - MCU_memory[enemyIdx*0x33+0x1826+0x12+0x03];

// 随机数生成 (0-99)
UINT16 random = SysRand() % 100;

// 魔法释放判定
if (random < intelligence) {
    // 敌人选择释放魔法 (概率 = intelligence/100)
    selectMagicToUse();
} else {
    // 敌人选择普通攻击
    usePhysicalAttack();
}
```

### 2. 魔法选择算法
```c
// 前置条件检查
UINT16 magicChainPtr = MCU_memory[enemyIdx*0x33+0x1826+0x31];
UINT8 learnedCount = MCU_memory[enemyIdx*0x33+0x1826+0x02];
UINT16 currentMP = MCU_memory[enemyIdx*0x33+0x1826+0x12+0x0C];

if (magicChainPtr != 0x0000 && learnedCount > 0) {
    // 随机选择一个已学会的魔法
    UINT8 selectedIdx = random % learnedCount;
    
    // 获取魔法类型和索引
    UINT8 magicType = MCU_memory[selectedIdx * 2 + magicChainPtr];
    UINT8 magicIndex = MCU_memory[selectedIdx * 2 + magicChainPtr + 1];
    
    // 获取魔法属性数据
    MagicData* magicData = getMagicData(magicType, magicIndex);
    
    // MP消耗检查
    if (currentMP >= magicData->mpCost && 
        MCU_memory[enemyIdx*0x07+0x1901+0x05] == 0xFF) { // 状态检查
        // 可以释放魔法
        useMagic(magicType, magicIndex);
    } else {
        // MP不足或状态异常，使用普通攻击
        usePhysicalAttack();
    }
}
```

## 魔法伤害计算公式

### 敌人攻击玩家的魔法伤害

#### HP伤害计算
```c
// 基础伤害 = 法术基础HP伤害
UINT16 baseDamage = spellData.hpDamage;

// 施法者(敌人)灵力加成
baseDamage += MCU_memory[enemyPtr+0x02] * (baseDamage >> 6);

// 目标(玩家)灵力抗性
baseDamage -= MCU_memory[playerPtr+0x17] * (baseDamage >> 6);

// 随机浮动
UINT16 randomValue = SysRand();
baseDamage += (randomValue % baseDamage) >> 4;

// 特殊减伤检测
if (MCU_memory[*(UINT16*)(MCU_memory+(playerId<<1)+0x181E)] == 0x05 || 
    MCU_memory[playerId+0x1916]) {
    // 特殊防护：减伤25%
    baseDamage -= baseDamage >> 2;
}

// 最终伤害限制
if (baseDamage > playerCurrentHP) {
    finalDamage = playerCurrentHP;
} else {
    finalDamage = baseDamage;
}
```

#### MP伤害计算
```c
// 基础MP伤害 = 法术基础MP伤害
UINT16 mpDamage = spellData.mpDamage;

// 施法者(敌人)灵力影响（减少MP伤害）
mpDamage -= MCU_memory[enemyPtr+0x02] * (mpDamage >> 6);

// 目标(玩家)灵力影响（增加MP伤害）
mpDamage += MCU_memory[playerPtr+0x17] * (mpDamage >> 6);

// 随机浮动
mpDamage += (randomValue % mpDamage) >> 4;

// 最终MP伤害限制
if (mpDamage > playerCurrentMP) {
    finalMPDamage = playerCurrentMP;
} else {
    finalMPDamage = mpDamage;
}
```

### 敌人攻击敌人的魔法伤害（治疗/辅助）

#### HP恢复计算
```c
// 基础恢复 = 法术基础HP恢复值
UINT16 baseHealing = spellData.hpHealing;

// 施法者灵力加成
baseHealing += MCU_memory[casterPtr+0x02] * (baseHealing >> 6);

// 目标灵力影响
baseHealing -= MCU_memory[targetPtr+0x02] * (baseHealing >> 6);

// 随机浮动
baseHealing += (randomValue % baseHealing) >> 4;

// 最终恢复量限制
UINT16 maxHealing = targetMaxHP - targetCurrentHP;
if (baseHealing > maxHealing) {
    finalHealing = maxHealing;
} else {
    finalHealing = baseHealing;
}
```

## 命中率计算

### 魔法命中检测
```c
// 敌人身法 = 敌人身法增减益 + 敌人角色身法
UINT16 enemyAgility = MCU_memory[enemyIdx*0x05+0x180F+0x04] + 
                     MCU_memory[enemyIdx*0x33+0x1826+0x12+0x01];

// 玩家身法 = 玩家身法增减益 + 玩家角色身法 + 50（基础加成）
UINT16 playerAgility = MCU_memory[playerId*0x05+0x1800+0x04] + 
                      MCU_memory[playerPtr+0x17] + 50;

// 身法差值计算
UINT16 agilityDiff;
if (enemyAgility > playerAgility) {
    agilityDiff = enemyAgility - playerAgility;
} else {
    agilityDiff = 10; // 最小命中率保底
}

// 命中判定：random % 200 < agilityDiff
UINT16 hitRoll = SysRand() % 200;
bool isHit = (hitRoll < agilityDiff);
```

## 状态效果计算

### 异常状态施加
```c
// 敌人普通攻击状态效果 [bit3:毒,bit2:乱,bit1:封,bit0:眠]
UINT8 statusEffects = MCU_memory[enemyIdx*0x33+0x1826+0x04] & 0x0F;

if (statusEffects != 0) {
    // 效果持续回合数
    UINT8 duration = MCU_memory[enemyIdx*0x33+0x1826+0x12+0x05];
    
    // 状态效果检测和应用
    if (statusEffects & 0x01) applyStatus(SLEEP, duration);    // 眠
    if (statusEffects & 0x02) applyStatus(SEAL, duration);     // 封
    if (statusEffects & 0x04) applyStatus(CONFUSE, duration);  // 乱
    if (statusEffects & 0x08) applyStatus(POISON, duration);   // 毒
}
```

## 关键常量定义

```c
// 内存地址常量
#define ENEMY_BASE_ADDR         0x1826  // 敌人数据基址
#define ENEMY_STRUCT_SIZE       0x33    // 单个敌人数据大小
#define ENEMY_ATTR_MODIFIER     0x180F  // 敌人属性增减益基址
#define PLAYER_ATTR_MODIFIER    0x1800  // 玩家属性增减益基址

// 魔法相关偏移
#define ENEMY_MAGIC_CHAIN_PTR   0x31    // 魔法链指针偏移
#define ENEMY_LEARNED_COUNT     0x02    // 学会魔法数量偏移
#define ENEMY_INTELLIGENCE      0x15    // 智商偏移（相对属性开始）
#define ENEMY_SPIRIT           0x14    // 灵力偏移
#define ENEMY_AGILITY          0x13    // 身法偏移

// 状态效果位掩码
#define STATUS_SLEEP           0x01     // 眠
#define STATUS_SEAL            0x02     // 封
#define STATUS_CONFUSE         0x04     // 乱  
#define STATUS_POISON          0x08     // 毒

// 命中率常量
#define PLAYER_AGILITY_BASE    50       // 玩家身法基础加成
#define HIT_ROLL_RANGE        200       // 命中判定随机数范围
#define MIN_HIT_CHANCE        10        // 最小命中率保底
```

## 实现注意事项

### 1. 随机数系统
- 使用 `SysRand()` 函数生成随机数
- 概率计算基于 0-99 范围的随机数
- 命中判定使用 0-199 范围的随机数

### 2. 内存管理
- 敌人魔法链数据存储在动态分配的内存中
- 需要在战斗结束时释放魔法链内存
- 内存不足时敌人无法释放魔法

### 3. 状态检查
- 敌人被封印时无法释放魔法
- MP不足时自动回退到普通攻击
- 特殊状态影响伤害计算

### 4. 精度考虑
- 所有伤害计算使用整数运算
- 位移运算用于快速除法（>> 6 相当于 /64）
- 随机浮动使用模运算和位移

## 游戏平衡设计

### 智商影响
- 智商值越高，释放魔法概率越大
- 智商 = 100 - 原始智商值（数值越小智商越高）
- 最高智商敌人有 99% 概率释放魔法

### 灵力机制
- 施法者灵力增加伤害输出
- 目标灵力提供魔法抗性
- 灵力影响约为基础伤害的 1.5625% (1/64)

### 特殊防护
- 某些装备或状态提供 25% 魔法减伤
- 玩家相比敌人拥有 +50 身法加成
- 最小命中率保证即使身法差距很大也有基础命中概率

此文档基于原版 C 引擎代码分析，完整还原了敌人AI的魔法释放决策和伤害计算系统。